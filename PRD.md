# SoundWave PRD（产品需求说明）

## 1. 背景与目标
- 为移动端（iOS/Android）提供音频播放与实时可视化（时域波形、频域谱）的体验，支持本地文件与流式来源。
- 目标：低延迟、稳定帧率、基础交互（播放/暂停/拖动/缩放）、弱网与长时间播放稳定性。

## 2. 目标用户与使用场景
- 目标用户：音频创作/剪辑用户、播客创作者、二次元配音、K 歌/练习用户、技术研发人员需要测试音频流。
- 核心场景：
  - 在移动端加载本地音频文件，查看时域波形并播放。
  - 拉取在线流式音频（URL），实时播放并查看波形/频谱。
  - 拖动/点击进度条快速定位；缩放波形局部观察；查看基本播放状态。
  - 弱网或切后台后继续保持播放稳定，前台返回快速恢复可视化。

## 3. 成功度量（KPI）
- 播放端到端延迟（解码到耳机/扬声器）：< 120 ms（理想值，硬件允许下）。
- UI 显示延迟（PCM 采集到波形/谱显示）：< 200 ms。
- UI 渲染帧率：60 fps（性能不足设备可自适应降级到 30 fps）。
- 长时间播放稳定性：连续 2 小时无明显 XRuns/音频卡顿，内存增长 < 5%。
- 崩溃率：< 0.1%，错误有明确提示与日志。

## 4. 范围与交付（MVP → 扩展）
- MVP
  - 本地文件播放：支持常见格式（mp3, aac/m4a, wav, flac）。
  - 流式播放：给定 URL（HTTP/HTTPS）拉流解码。
  - 实时时域波形：分帧 PCM 抽样绘制。
  - 基础频域谱：基于 FFT 的功率谱，支持刷新显示。
  - 播放控制：播放/暂停/seek（跳转）、显示当前播放时间与总时长。
  - 基础异常处理：网络错误/文件缺失/不支持格式/解码错误提示。
- 跨平台音频核心：Android/iOS 共用同一套 C/C++ 算法与音频处理库，通过平台桥接层暴露统一接口，默认采用 FFmpeg 解码（平台解码器为兜底）。
- 扩展（非 MVP，规划项）
  - 立体声通道分离显示、能量峰值指示。
  - 录音输入可视化（环回/麦克风）。
  - 波形截图/导出。
  - 标注/书签与区域循环播放。
  - 主题皮肤与显示调节（颜色、对数/线性频率）。

## 5. 用户流程（简述）
- 打开 App → 选择来源（本地文件/输入 URL）→ 加载 → 点击播放 → 实时看到波形/频谱刷新。
- 在播放中可拖动进度条或点击波形跳转 → 音频与可视化同步更新。
- 可双指缩放波形查看局部；如果弱网卡顿，显示缓冲状态/提示。

## 6. 功能需求
- 播放与控制
  - 支持播放/暂停/停止、跳转到指定时间。
  - 显示当前时间、总时长、缓冲进度（流式）。
  - 支持后台播放（至少不崩溃/不中断，可选是否静音可视化）。
- 数据来源
  - 本地：文件选择/文件路径输入。
  - 网络：输入 URL，基础鉴权 header 预留（MVP 可不做 UI，只在配置层预留）。
- 可视化
  - 时域波形：基于分帧 PCM；支持抽稀策略避免过度绘制。
  - 频域谱：可配置窗口大小、重叠度；展示幅度/功率。
  - 交互：拖动/点击跳转，双指缩放波形视窗。
- 性能与同步
  - 音频时钟驱动 UI，同步误差尽量 < 50 ms。
  - 数据通道限速：避免过高帧率推送压垮 UI 线程。
  - 低延迟目标下的缓冲与线程策略（解码线程、回放线程、FFT/处理线程与 UI 线程解耦）。
- 错误与恢复
  - 网络超时/断网、解码失败、文件缺失、不支持格式时给出用户可读提示。
  - 前后台切换恢复：回到前台后波形/谱继续刷新；弱网时自动重试或提示。

## 7. 非功能需求
- 性能：低延迟、稳定帧率、内存可控（避免大对象频繁分配，重用缓冲）。
- 兼容性：iOS 14+/Android 7.0+（可根据依赖调整）。
- 可测试性：核心逻辑可单测；集成测试覆盖播放与可视化基本路径；长时间播放压测脚本。
- 监控与日志：关键指标（缓冲耗时、解码耗时、UI fps、XRuns、CPU/内存）采集与可导出日志。

## 8. 技术与实现约束
- UI：Flutter 实现；使用自定义绘制组件（CustomPainter）绘制波形/谱。
- 插件：Flutter plugin 封装 C/C++/平台能力，MethodChannel/PlatformChannel 通信。
- 音频核心：C/C++，默认 FFmpeg 解码；必要时平台解码器兜底。环形缓冲、窗口化 + FFT（KissFFT/vDSP/Android FFT）；核心算法库跨平台通用，仅在平台层做少量 IO/权限适配。
- 构建：CMake 管理原生核心；Flutter 构建移动端包。

## 9. 依赖与外部接口
- 第三方库：FFmpeg（主要解码后端）、KissFFT/平台 FFT；平台解码器作为可选替代。
- 系统能力：文件访问、网络请求、音频输出、前后台生命周期。
- 可选：日志/埋点上报 SDK（MVP 可本地存储或调试输出）。

## 10. 风险与缓解
- FFmpeg 移动端编译复杂：预编译静态库、使用缓存；必要时切换平台解码器。
- 线程竞争/锁导致 XRuns：采用环形缓冲、无锁队列，避免在回放回调做重计算。
- UI 绘制压力大：抽稀、批量绘制、降级帧率；采用纹理/缓存位图。
- 流式弱网：超时与重连策略、缓冲大小自适应，提供可视化提示。

## 11. 里程碑与验收要点
- M1：本地文件播放 + 基础波形显示；验收：无明显延迟卡顿，基本播放控制可用。
- M2：流式播放 + 实时时域波形、基础频谱；验收：弱网有提示，谱刷新正常。
- M3：交互完善（拖动/缩放），性能调优；验收：帧率与延迟达标，长时间播放稳定。
- M4：测试/监控完善，打包与分发流程；验收：CI 通过、压测达标、日志可导出。
